version: 2.1

#### This is the forkeeeee

jobs:
  premier:
    docker:
      - image: circleci/node
    steps:
      - run:
          command: |
                   echo job1
                   sleep 2
      
  deuxieme:
    docker:
      - image: circleci/node
    steps:
      - run:
          command: |
                   echo job2
                   echo << pipeline.project.git_url >>
                   echo ${CIRCLE_USERNAME}
                   echo << pipeline.project.git_url >>
                                      
 
  troisieme:
    docker:
      - image: circleci/node
    steps:
      - run:
          command: |
                   echo jobnum3
                                     
workflows:
  version: 2
  papa:
    when:
      equal: [ "https://github.com/yaningo/dockercli", << pipeline.project.git_url >> ]
     # equal: [ "tech5irl", ${CIRCLE_USERNAME} ]
    jobs:
      - premier
      - wait-for-approval:
          type: approval
          requires:
            - premier
      - deuxieme:
          pre-steps: # steps to run before steps defined in the job bar
              - run:
                  command: |
                    WHO_APPROVED_ID=$(curl -X GET https://circleci.com/api/v2/workflow/${CIRCLE_WORKFLOW_ID}/job -H "Circle-Token: ${MyToken}" | jq -r '.items[]|select(.type == "approval")|.approved_by')
                    echo ${WHO_APPROVED_ID}
                    WHO_APPROVED_USERNAME=$(curl -X GET https://circleci.com/api/v2/user/${WHO_APPROVED_ID} -H "Circle-Token: ${MyToken}" | jq -r .login)
                    ACCESS_GRANTED=false
                    echo ${WHO_APPROVED_USERNAME}
                    for OUTPUT in $(curl -u"${BB_admin_username}:${BB_admin_App_Password}" --request GET https://api.bitbucket.org/1.0/groups/yndmgo/${Approvers_Group}/members|jq '.[].nickname'|sed 's/"//g')
                    do
                      if [[ $OUTPUT = ${WHO_APPROVED_USERNAME} ]]; then
                        ACCESS_GRANTED=true
                      fi
                    done

                    if [[ ACCESS_GRANTED=false ]]; then
                      curl -X POST https://circleci.com/api/v2/workflow/${CIRCLE_WORKFLOW_ID}/cancel -H "Circle-Token: ${MyToken}"
                    fi
          requires:
            - wait-for-approval
  # papu:
  #  jobs:
  #    - premier
  
  tata:
    jobs:
      - deuxieme
      
#  tata:
#    jobs:
#      - deuxieme:
#          context: Lecontext
  lala:
    jobs:
      - troisieme:
          context: Lecontext
